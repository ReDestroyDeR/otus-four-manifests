apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: otus-four-request-auth-jwt
  namespace: otus-four
spec:
  selector:
    matchLabels:
      app: business
  jwtRules:
    - issuer: "auth.arch.homework"
      # jwksUri: "http://auth-service.otus-four.svc.cluster.local/.well-known/jwks.json"
      jwksUri: "https://gist.githubusercontent.com/ReDestroyDeR/de79293b46575df5d41641c5e20a07f2/raw/a2d273e354577925f6287322007a45d611dbe3ec/jwks.json"
---

apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: otus-four-authorization-policy-jwt
  namespace: otus-four
spec:
  selector:
    matchLabels:
      app: business
  action: ALLOW
  rules:
    - from:
        - source:
            namespaces:
              - "otus-four"
    - to:
        - operation:
            methods:
              - "GET"
              - "PATCH"
            paths:
              - "/"
      when:
        - key: request.auth.claims[iss]
          values:
            - "auth.arch.homework"

---

apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: otus-four-authentication-service-policy
  namespace: otus-four
spec:
  selector:
    matchLabels:
      app: authentication
  action: ALLOW
  rules:
    - to:
        - operation:
            methods:
              - "POST"
              - "GET"
              - "PATCH"
              - "DELETE"

